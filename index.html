<!DOCTYPE html>
<html>
<head>
	<title>Tree View</title>
	 <link type="text/css" href="css/slickgrid/grid.css" rel="stylesheet" />
	 <script src="https://use.fontawesome.com/d5c97b2a3c.js"></script>
	 <script type="text/javascript" src="js/jquery/jquery.js"></script>
	 <script type="text/javascript" src="js/jquery/jquery-ui-1.11.3.custom.min.js"></script>
     <script type="text/javascript" src="js/jquery/jquery.event.drag-2.2-min.js"></script>
     <script type="text/javascript" src="js/slickgrid/slick.core.js"></script>
     <script type="text/javascript" src="js/slickgrid/slick.grid.js"></script>
     <script type="text/javascript" src="js/slickgrid/slick.dataview.js"></script>
     <script type="text/javascript" src="js/slickgrid/slick.editors.js"></script>

     <style type="text/css">
     	 .cell-title {
      		font-weight: bold;
   		 }

	    .cell-effort-driven {
	      text-align: center;
	    }

	    .toggle {
	      height: 9px;
	      width: 9px;
	      display: inline-block;
	    }

	    .toggle.expand {
	      background: url(img/expand.gif) no-repeat center center;
	    }

	    .toggle.collapse {
	      background: url(img/collapse.gif) no-repeat center center;
	    }

	    .checkbox {
	      height: 15px;
	      width: 15px;
	      display: inline-block;
	    }

	    .checkbox.checked {
	    	background: url(img/checked.png) no-repeat center center;
	    }

	    .checkbox.unchecked {
	    	background: url(img/unchecked.png) no-repeat center center;
	    }

	    .checkbox.indeterminate {
	    	background: url(img/indeterminate.png) no-repeat center center;
	    }
	     
      </style>
     <script type="text/javascript">
     	var toggleFormatter = function (row, cell, value, columnDef, dataContext) {
     		value = value.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");

     		var item = dataView.getItem(row);
     		if (item.selected === "checked") {
     			value = " <span><i class='fa fa-check-square' aria-hidden='true'></i></span>&nbsp;" + value;
     		} else if (item.selected === "unchecked") {
     			value = " <span><i class='fa fa-square-o' aria-hidden='true'></i></span>&nbsp;" + value;
     		} else {
     			value = " <span><i class='fa fa-square' aria-hidden='true'></i></span>&nbsp;" + value;
     		}
			
			var spacer = "<span style='display:inline-block;height:1px;width:" + (15 * dataContext["indent"]) + "px'></span>";
			var idx = dataView.getIdxById(dataContext.id);
			if (data[idx + 1] && data[idx + 1].indent > data[idx].indent) {
				if (dataContext._collapsed) {
					return spacer + " <span class='toggle expand'></span>&nbsp;" + value;
				} else {
					return spacer + " <span class='toggle collapse'></span>&nbsp;"  + value;
				}
			} else {
				return spacer + " <span class='toggle'></span>&nbsp;" +  value;
			}

			columnDef.width = 5;
		};

		function CheckmarkFormatter(row, cell, value, columnDef, dataContext) {
   			 return value ? "<img src='img/expand.gif'>" : "";
  		}

		var dataView;
		var grid;
		var data = [];
		var columns = [
			{id: "title", name: "", field: "title", formatter: toggleFormatter}
		    //{id: "test", name:"", field: "test", formatter: CheckmarkFormatter}
		  
		];

		var options = { 
		    enableCellNavigation: true, 
		    forceFitColumns: true
		};

		 

		function myFilter(item) {
		  
		  if (item.parent != null) {
		    var parent = data[item.parent.id];
		       
		    while (parent) {
		      if (parent._collapsed) {
		        return false;
		      }
		        parent = data[parent.parent ? parent.parent.id : null];
		         
		    }
		  }

		  return true;
		}



		$(function () {
		  var indent = 0;
		  data = [{id:1, selected: 'unchecked', title: '1-800-Flowers',  indent: 0, parent: null},
		  {id:2, selected: 'unchecked', title: 'Agoura Hills',  indent: 1, parent:{id: 0}},
		  {id:3, selected: 'unchecked', title: 'CA',  indent: 2, parent:{id: 1}},
		  {id:4, selected: 'unchecked', title: 'United States',   indent: 3, parent:{id: 2}},
		  {id:5, selected: 'unchecked', title: 'Alameda',  indent:  1, parent:{id: 0}},
		  {id:6, selected: 'unchecked', title: 'CA',  indent: 2, parent: {id: 4} },
		  {id:7, selected: 'unchecked', title: 'United States',  indent: 3, parent:{id: 5}}]
		    		    
		  // initialize the model
		  dataView = new Slick.Data.DataView();
		  dataView.beginUpdate(); 
		  dataView.setItems(data); 
		  dataView.setFilter(myFilter);
		  dataView.endUpdate();

		  //TODO: Need to merge logic of these 2 function
		  function getChildren(row) {
		  	var currentItem = dataView.getItem(row);
		  	var allItems = dataView.getItems();
		  	var lastIndex = allItems.length - 1;
		  	var children = [];
		  	for(var i = row + 1; i <= lastIndex; i++) {
		  		if (allItems[i].parent.id == row) {
		  			children.push(allItems[i]);
		  			var items = getChildren(i);
		  			children.push(...items);
		  		}
		  	}
		  	return children;
		  }

		  function getImmediateChildren(row) {
		  	var currentItem = dataView.getItem(row);
		  	var allItems = dataView.getItems();
		  	var lastIndex = allItems.length - 1;
		  	var children = [];
		  	for(var i = row + 1; i <= lastIndex; i++) {
		  		if (allItems[i].parent.id == row) {
		  			children.push(allItems[i]);
		  		}
		  	}
		  	return children;

		  }
		  

		  function getParent(row) {
		  	var currentItem = dataView.getItem(row);
		  	if (currentItem.parent === null) {
		  		return null;	
		  	} else {
		  		return dataView.getItem(currentItem.parent.id);
		  	}
		  }

		  // initialize the grid
		  grid = new Slick.Grid("#myGrid", dataView, columns, options);

		  grid.onCellChange.subscribe(function (e, args) {
		    dataView.updateItem(args.item.id, args.item);
		  });  

		  grid.onClick.subscribe(function (e, args) {
		  	var item = dataView.getItem(args.row);
		    if ($(e.target).hasClass("toggle")) {
		      if (item) {
		        if (!item._collapsed) {
		          item._collapsed = true;
		        } else {
		          item._collapsed = false;
		        }

		        dataView.updateItem(item.id, item);
		      }
		      e.stopImmediatePropagation();
		    } else if ($(e.target).hasClass('fa')) {
		    	dataView.beginUpdate(); 
		    	
		    	if (item.selected === "unchecked") {
		    		checkItem(item);
		    	} else {
		    		uncheckItem(item);
		    	}
		    	dataView.endUpdate();
		    	
		    }

		  });

		  function checkItem(item) {
		  	item.selected = "checked";
    		dataView.updateItem(item.id, item);
	    	var children = getChildren(dataView.getIdxById(item.id));
	    	for (let child of children) {
	    		child.selected = "checked";
	    		dataView.updateItem(child.id, child);
	    	}

	    	updateParent(item.id, "checked");
		  }

		  function uncheckItem(item) {
		  	item.selected = "unchecked";
    		dataView.updateItem(item.id, item);
	    	var children = getChildren(dataView.getIdxById(item.id));
	    	for (let child of children) {
	    		child.selected = "unchecked";
	    		dataView.updateItem(child.id, child);
	    	}

	    	updateParent(item.id, "unchecked")
		  }

		  function updateParent(id, childChangedState) {
		  	var parent = getParent(dataView.getIdxById(id));
		  	if (parent == null) {
		  		return;
		  	}
		  	var currentState = parent.selected;
		  	if (childChangedState === "checked") {
		  		var immediateChildren = getImmediateChildren(dataView.getIdxById(parent.id));
		  		var allChecked = false;
		  		for (let child of immediateChildren) {
		  			if (child.selected === "checked") {
		  				allChecked = true;
		  			} else {
		  				allChecked = false;
		  				break;
		  			}
		  		}

		  		if (allChecked) {
		  			parent.selected = "checked";
		  			dataView.updateItem(parent.id, parent);
		  			updateParent(parent.id, "checked");
		  		} else {
		  			if (currentState !== "indeterminate") {
		  				parent.selected = "indeterminate";
			  			dataView.updateItem(parent.id, parent);
			  			updateParent(parent.id, "indeterminate");	
		  			}
		  		}
		  	} else if (childChangedState === "unchecked") {
		  		var immediateChildren = getImmediateChildren(dataView.getIdxById(parent.id));
	  			var allUnchecked = false;
	  			for (let child of immediateChildren) {
	  				if (child.selected === "unchecked") {
	  					allUnchecked = true;
	  				} else {
	  					allUnchecked = false;
	  					break;
	  				}
	  			}

	  			if (allUnchecked) {
	  				parent.selected = "unchecked";
	  				dataView.updateItem(parent.id, parent);
	  				updateParent(parent.id, "unchecked");
	  			} else {
	  				if (currentState !== "indeterminate") {
	  					parent.selected = "indeterminate";
	  					dataView.updateItem(parent.id, parent);
		  				updateParent(parent.id, "indeterminate");	
	  				}
	  			}
		  	}

		}
		  

		  // wire up model events to drive the grid
		  dataView.onRowCountChanged.subscribe(function (e, args) {
		    grid.updateRowCount();
		    grid.render();
		  });

		  dataView.onRowsChanged.subscribe(function (e, args) {
		    grid.invalidateRows(args.rows);
		    grid.render();
		  });
		}) 
     </script>
</head>
<body>
	<div id="myGrid" style="width:600px;height:500px;"></div>
</body>
</html>